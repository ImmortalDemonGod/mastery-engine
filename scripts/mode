#!/bin/bash
# scripts/mode - Mastery Engine Mode Manager
#
# Usage:
#   ./scripts/mode status              # Show current mode
#   ./scripts/mode switch student      # Switch to student mode
#   ./scripts/mode switch developer    # Switch to developer mode
#   ./scripts/mode test student "cmd"  # Test in mode without switching

set -e

MODE_DIR="modes"
WORKSPACE="cs336_basics"
MODE_LINK=".active-mode"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

current_mode() {
    if [ -L "$MODE_LINK" ]; then
        basename $(readlink "$MODE_LINK")
    else
        echo "none"
    fi
}

show_status() {
    local mode=$(current_mode)
    
    echo "═══════════════════════════════════════"
    echo "  Mastery Engine - Mode Status"
    echo "═══════════════════════════════════════"
    echo ""
    
    if [ "$mode" = "none" ]; then
        echo -e "${RED}✗ No active mode${NC}"
        echo ""
        echo "Initialize with:"
        echo "  ./scripts/mode switch student"
        echo "  ./scripts/mode switch developer"
        return 1
    fi
    
    echo -e "${GREEN}✓ Active mode: $mode${NC}"
    echo ""
    echo "Workspace:"
    if [ -L "$WORKSPACE" ]; then
        echo -e "  ${BLUE}$WORKSPACE/ → $(readlink $WORKSPACE)${NC}"
    else
        echo -e "  ${RED}ERROR: $WORKSPACE/ is not a symlink${NC}"
    fi
    echo ""
    
    # Show key files
    if [ -f "$WORKSPACE/utils.py" ]; then
        local line_count=$(wc -l < "$WORKSPACE/utils.py" | tr -d ' ')
        local has_todo=0
        if grep -q "NotImplementedError" "$WORKSPACE/utils.py" 2>/dev/null; then
            has_todo=$(grep -c "NotImplementedError" "$WORKSPACE/utils.py")
        fi
        
        echo "Files:"
        echo "  utils.py: $line_count lines"
        if [ "$has_todo" -gt 0 ]; then
            echo -e "    ${YELLOW}[$has_todo TODO stubs]${NC}"
        else
            echo -e "    ${GREEN}[Complete implementations]${NC}"
        fi
    fi
}

switch_mode() {
    local target_mode=$1
    local current=$(current_mode)
    
    if [ "$target_mode" != "student" ] && [ "$target_mode" != "developer" ]; then
        echo -e "${RED}Error: Mode must be 'student' or 'developer'${NC}"
        exit 1
    fi
    
    if [ "$current" = "$target_mode" ]; then
        echo -e "${YELLOW}Already in $target_mode mode${NC}"
        return 0
    fi
    
    echo -e "${BLUE}Switching to $target_mode mode...${NC}"
    
    # Check for uncommitted changes in workspace
    if [ "$current" != "none" ] && [ -d "$WORKSPACE" ] && [ ! -L "$WORKSPACE" ]; then
        echo -e "${RED}✗ $WORKSPACE/ is not a symlink - manual intervention required${NC}"
        echo "The workspace should be a symlink, not a regular directory."
        echo "Please backup and remove it, then try again."
        exit 1
    fi
    
    # Remove old workspace symlink
    if [ -L "$WORKSPACE" ]; then
        rm "$WORKSPACE"
    elif [ -d "$WORKSPACE" ]; then
        echo -e "${RED}✗ $WORKSPACE/ is a directory, not a symlink${NC}"
        echo "Backup and remove it manually, then try again."
        exit 1
    fi
    
    # Create new symlink
    ln -s "$MODE_DIR/$target_mode/$WORKSPACE" "$WORKSPACE"
    
    # Update mode tracker
    rm -f "$MODE_LINK"
    ln -s "$MODE_DIR/$target_mode" "$MODE_LINK"
    
    echo -e "${GREEN}✓ Switched to $target_mode mode${NC}"
    echo ""
    show_status
}

test_in_mode() {
    local test_mode=$1
    shift
    local test_cmd="$@"
    local original_mode=$(current_mode)
    
    echo "═══════════════════════════════════════"
    echo -e "  ${YELLOW}Testing in $test_mode mode${NC}"
    echo "═══════════════════════════════════════"
    echo ""
    
    # Temporarily switch
    switch_mode "$test_mode" > /dev/null
    
    # Run tests
    eval "$test_cmd"
    local exit_code=$?
    
    # Switch back
    if [ "$original_mode" != "none" ] && [ "$original_mode" != "$test_mode" ]; then
        echo ""
        echo -e "${BLUE}Restoring $original_mode mode...${NC}"
        switch_mode "$original_mode" > /dev/null
    fi
    
    return $exit_code
}

case "${1:-}" in
    status)
        show_status
        ;;
    switch)
        switch_mode "${2:-}"
        ;;
    test)
        test_in_mode "${2:-}" "${@:3}"
        ;;
    help|--help|-h)
        echo "Mastery Engine Mode Manager"
        echo ""
        echo "Manages dual-mode repository for student and developer workflows."
        echo ""
        echo "Usage:"
        echo "  ./scripts/mode status                      # Show current mode"
        echo "  ./scripts/mode switch student              # Switch to student mode"
        echo "  ./scripts/mode switch developer            # Switch to developer mode"
        echo "  ./scripts/mode test student 'pytest ...'   # Test in mode temporarily"
        echo ""
        echo "Modes:"
        echo "  student    - TODO stubs, tests fail until implemented"
        echo "  developer  - Complete implementations, tests pass"
        echo ""
        echo "The workspace (cs336_basics/) is a symlink to modes/{mode}/cs336_basics/"
        echo "Edit source files in modes/student/ or modes/developer/ as needed."
        ;;
    *)
        show_status
        ;;
esac
