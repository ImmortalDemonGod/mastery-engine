{
  "id": "gradient-clipping-per-parameter",
  "description": "Per-parameter clipping instead of global norm",
  "injection_type": "ast",
  "engine_version": "2.1",
  "target_function": "clip_gradients_by_global_norm",
  "logic": [
    {
      "pass": 1,
      "type": "find_and_replace",
      "pattern": {
        "node_type": "Assign",
        "targets": [{"node_type": "Name", "id": "total_norm"}]
      },
      "replacement": {"type": "delete_statement"}
    },
    {
      "pass": 2,
      "type": "find_and_replace",
      "pattern": {
        "node_type": "If",
        "test": {"node_type": "Compare"}
      },
      "replacement": {
        "type": "replace_with",
        "source": "for g in grads:\n    grad_norm = g.detach().norm(2)\n    if grad_norm > max_l2_norm:\n        clip_coef = max_l2_norm / (grad_norm + 1e-6)\n        g.mul_(clip_coef)"
      }
    }
  ]
}